# 5장-ARP 프로토콜

## 1. ARP 프로토콜(Address Resolution Protocol)

### ARP가 하는 일

> 같은 네트워크 대역에서 통신을 하기 위해 필요한 **MAC 주소를, IP 주소를 이용해서 알아오는 프로토콜**

같은 네트워크 대역에서 통신한다 하더라도 데이터를 보내기 위해서는 7계층부터 캡슐화를 통해서 데이터를 보내기 때문에 IP 주소와 MAC 주소가 모두 필요하다.

이 때, IP주소는 알고 MAC 주소는 모르더라도 ARP를 통해서 통신이 가능한 것이다.

### ARP 프로토콜의 구조

![image](https://user-images.githubusercontent.com/93081720/207258176-f784037a-9cfe-4bdb-b26c-f362943b2ad2.png)

1칸이 8비트 => 1줄이 4바이트 => 7줄이 있으니 28바이트

#### Hardware type

2계층에서 사용하는 프로토콜의 타입

일반적으로 이더넷이 오므로 (0x)0001로 표현됨

#### Hardware Address Length

MAC 주소의 길이 => 6바이트 => 06라는 값이 입력됨

#### Protocol type

프로토콜 주소의 타입

IP 주소 타입 밖에 없으므로 (0x)0800이 옴

#### Protocol Address Length

IPv4 주소는 4바이트이므로 04라는 값이 입력됨

#### Opcode

요청인지 요청에 대한 응답인지 확인하는 코드

요청 = 1, 응답 = 2

#### Source Hardware Address (6바이트)

출발지의 MAC 주소가 들어가는 공간

#### Source Protocol Address (4바이트)

출발지의 IP 주소가 들어가는 공간

#### Destination Hardware Address (6바이트)

목적지의 MAC 주소가 들어가는 공간

#### Source Protocol Address (4바이트)

목적지의 IP 주소가 들어가는 공간

<br>

## 2. ARP 프로토콜의 통신 과정

### IP 주소로 MAC 주소를 알아오는 과정

IP 주소만 알고 있을 때, 상대방의 MAC 주소를 알아오는 과정

컴퓨터가 A, B, C, D 총 4대가 있다고 가정하고 A 컴퓨터에서 C 컴퓨터로 통신하고자 함

1. A 컴퓨터가 ARP 요청 프로토콜을 만듦(Opcode 1번)
2. 목적지 MAC 주소는 모르니 `00 00 00 00 00 00 00`으로 비워두고, C 컴퓨터(목적지)의 IP 주소를 작성해둠
3. 캡슐화해야 하니 Ethernet 프로토콜을 작성함. Ethernet 프로토콜에 들어가는 MAC 주소 역시 모르니 `FF FF FF FF FF FF`로 작성해 둠(이는 2진수로 전부 1로 쓴 것과 같으므로 **브로드 캐스트** 통신임)
4. 같은 네트워크 대역의 모든 장비들에게 보냄(브로드 캐스트) => 스위치가 해당 요청을 받으면 스위치는 2계층 프로토콜까지만 확인하므로 브로드 캐스트임을 확인하고 연결된 모든 장비에 보냄
5. 받은 모든 장비들은 역캡슐화 과정을 거침
6. 2계층 프로토콜이 브로드 캐스트이므로 올바르게 도착한 것임을 확인하고, 3계층 프로토콜을 해석함
7. C 컴퓨터는 본인의 IP 주소가 일치하니 패킷을 유지하고, 나머지 컴퓨터들은 목적지가 본인의 IP 주소가 아니니까 해당 패킷을 버림
8. C 컴퓨터는 ARP 응답 프로토콜을 만듦(Opcode 2번)
9. 출발지 MAC 주소에 C 컴퓨터 자신의 MAC 주소를 써서 응답 요청을 보냄. 이 때, C는 받은 프로토콜에 A의 MAC 주소가 있으니 목적지 MAC 주소에 A의 MAC 주소를 작성 가능함
10. 응답 요청은 이제 MAC 주소를 알고 있으니 브로드 캐스트로 보낼 필요 없이 A에게 다이렉트로 전달 가능함
11. 스위치는 해당 요청의 2계층 프로토콜을 확인하고 A의 MAC 주소로 보내는 것을 확인하여 A에게 보냄

<br>

## 3. ARP 테이블

통신했던 컴퓨터들의 IP 주소와 MAC주소를 맵핑해둔 테이블

한번 통신했던 컴퓨터들의 주소는 ARP 캐시 테이블에 남는다. 그러나 캐시라는 말에서 알 수 있듯이 영원히 남는 것은 아니고 일정 시간이 지나면 사라진다.